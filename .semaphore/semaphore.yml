version: v1.0
name: Agent
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: "Tests"
    dependencies: []
    task:
      env_vars:
        - name: GO111MODULE
          value: "on"

      prologue:
        commands:
          - sem-version go 1.11
          - checkout
          - go version
          - go get
          - go build

      jobs:
        - name: Unit Tests
          commands:
            - make test

  - name: "Shell Executor E2E tests"
    dependencies:
      - "Tests"
    task:
      env_vars:
        - name: GO111MODULE
          value: "on"

      prologue:
        commands:
          - sem-version go 1.11
          - checkout
          - go version
          - go get
          - go build

      jobs:
        - name: Hello World
          commands:
            - make e2e TEST=shell/hello_world

        - name: Env Vars
          commands:
            - make e2e TEST=shell/env_vars

        - name: Failed Job
          commands:
            - make e2e TEST=shell/failed_job

        - name: Job Stopping
          commands:
            - make e2e TEST=shell/job_stopping

        - name: File Injection
          commands:
            - make e2e TEST=shell/file_injection

        - name: File Injection Broken File Mode
          commands:
            - make e2e TEST=shell/file_injection_broken_file_mode

        - name: Stty Restoration
          commands:
            - make e2e TEST=shell/stty_restoration

        - name: Epilogue On Pass
          commands:
            - make e2e TEST=shell/epilogue_on_pass

        - name: Epilogue On Fail
          commands:
            - make e2e TEST=shell/epilogue_on_fail

  - name: "Docker Executor E2E tests"
    dependencies:
      - "Tests"
    task:
      env_vars:
        - name: GO111MODULE
          value: "on"

      prologue:
        commands:
          - sem-version go 1.11
          - checkout
          - go version
          - go get
          - go build

      jobs:
        - name: Hello World
          commands:
            - make e2e TEST=docker/hello_world

        - name: Env Vars
          commands:
            - make e2e TEST=docker/env_vars

        - name: Failed Job
          commands:
            - make e2e TEST=docker/failed_job

        - name: Job Stopping
          commands:
            - make e2e TEST=docker/job_stopping

        - name: File Injection
          commands:
            - make e2e TEST=docker/file_injection

        - name: File Injection Broken File Mode
          commands:
            - make e2e TEST=docker/file_injection_broken_file_mode

        - name: Stty Restoration
          commands:
            - make e2e TEST=docker/stty_restoration

        - name: Epilogue On Pass
          commands:
            - make e2e TEST=docker/epilogue_on_pass

        - name: Epilogue On Fail
          commands:
            - make e2e TEST=docker/epilogue_on_fail

promotions:
  - name: Release
    pipeline_file: "release.yml"
    auto_promote_on:
      - result: passed
        branch:
          - "^refs/tags/v*"
